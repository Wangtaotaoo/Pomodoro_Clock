<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="blocked_title">专注模式中</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="themes.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Roboto', 'Noto Sans SC', sans-serif;
      background: var(--gradient-bg);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .blocked-page {
      text-align: center;
      max-width: 500px;
      padding: 40px 32px;
      background: var(--bg-card);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-radius: 28px;
      border: 1px solid var(--border-glass);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .blocked-page::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.5),
        transparent);
    }

    .blocked-icon {
      font-size: 80px;
      color: var(--accent-color);
      margin-bottom: 24px;
    }

    .blocked-page h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      letter-spacing: -0.5px;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .blocked-page p {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-weight: 500;
    }

    .site-info {
      background: var(--bg-glass);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }

    .site-info-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .site-info-url {
      font-size: 14px;
      color: var(--text-primary);
      font-weight: 500;
      word-break: break-all;
    }

    .timer {
      font-size: 32px;
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 32px;
      letter-spacing: -0.5px;
    }

    .actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      border: none;
      border-radius: 16px;
      padding: 16px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      letter-spacing: -0.3px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: white;
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 24px rgba(0, 122, 255, 0.4);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-glass);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      border-color: var(--accent-color);
      background: var(--accent-light);
      transform: translateY(-2px);
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    @media (max-width: 640px) {
      .blocked-page {
        margin: 16px;
        padding: 32px 24px;
        border-radius: 24px;
      }

      .blocked-icon {
        font-size: 64px;
      }

      .blocked-page h1 {
        font-size: 24px;
      }

      .blocked-page p {
        font-size: 14px;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
  <script src="i18n.js"></script>
</head>
<body>
  <div class="blocked-page">
    <span class="material-icons blocked-icon">block</span>
    <h1 data-i18n="blocked_title">专注模式中</h1>
    <p data-i18n="blocked_message">此网站已被暂时阻止，请专注于当前任务。</p>

    <div class="site-info">
      <div class="site-info-label" data-i18n="blocked_current_site">当前网站</div>
      <div class="site-info-url" id="blockedUrl">--</div>
    </div>

    <div class="timer" id="timerDisplay">05:00</div>

    <div class="actions">
      <button class="btn btn-secondary" id="allowOnceBtn">
        <span class="material-icons">schedule</span>
        <span data-i18n="btn_temp_access">临时访问 5 分钟</span>
      </button>
      <button class="btn btn-primary" id="endFocusBtn">
        <span class="material-icons">check_circle</span>
        <span data-i18n="btn_end_focus_access">结束专注，允许访问</span>
      </button>
    </div>
  </div>

  <script>
    const TIMER_ALARM_NAME = 'tomatoTimer';

    function getStorage(keys) {
      return new Promise((resolve) => chrome.storage.local.get(keys, resolve));
    }

    function setStorage(data) {
      return new Promise((resolve) => chrome.storage.local.set(data, resolve));
    }

    const blockedUrlEl = document.getElementById('blockedUrl');
    const timerDisplay = document.getElementById('timerDisplay');
    const allowOnceBtn = document.getElementById('allowOnceBtn');
    const endFocusBtn = document.getElementById('endFocusBtn');

    let allowedUrl = null;
    let allowedUntil = null;
    let timerInterval = null;

    // Initialize and apply i18n
    async function initI18nAndApply() {
      if (typeof initI18n === 'function') {
        await initI18n();
      }
      if (typeof applyI18nToDocument === 'function') {
        applyI18nToDocument();
      }
    }

    // Initialize
    async function init() {
      // First initialize i18n
      await initI18nAndApply();

      // Get blocked URL from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const blockedUrl = urlParams.get('url') || i18n('blocked_unknown_site');
      blockedUrlEl.textContent = blockedUrl;

      const result = await getStorage(['timerState', 'allowedSites', 'settings']);
      const timerState = result.timerState;

      // Apply theme
      const settings = result.settings || {};
      const theme = settings.theme || 'light';
      document.documentElement.setAttribute('data-theme', theme);

      // Show timer if focus is running
      if (timerState && timerState.isRunning && !timerState.isPaused) {
        updateTimerDisplay(timerState);
      } else {
        timerDisplay.textContent = i18n('blocked_not_focusing');
        allowOnceBtn.style.display = 'flex';
      }

      // Listen for changes
      chrome.storage.onChanged.addListener((changes) => {
        if (changes.timerState) {
          updateTimerDisplay(changes.timerState.newValue);
        }
      });
    }

    function updateTimerDisplay(timerState) {
      if (!timerState || !timerState.isRunning || timerState.isPaused) {
        timerDisplay.textContent = i18n('blocked_not_focusing');
        return;
      }

      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const remaining = timerState.endTime ? Math.max(0, Math.ceil((timerState.endTime - Date.now()) / 1000)) : 0;
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Allow temporary access
    allowOnceBtn.addEventListener('click', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const originalUrl = urlParams.get('original');

      allowedUrl = originalUrl;
      allowedUntil = Date.now() + 5 * 60 * 1000;

      const current = await getStorage(['allowedSites']);
      await setStorage({
        allowedSites: {
          ...(current.allowedSites || {}),
          [originalUrl]: allowedUntil
        }
      });

      window.location.href = originalUrl;
    });

    // End focus mode
    endFocusBtn.addEventListener('click', async () => {
      const result = await getStorage(['timerState']);
      const timerState = result.timerState;

      if (timerState && timerState.isRunning) {
        await chrome.alarms.clear(TIMER_ALARM_NAME);
        const pausedState = {
          ...timerState,
          isRunning: true,
          isPaused: true,
          remainingSeconds: Math.max(0, Math.ceil((timerState.endTime - Date.now()) / 1000)),
          endTime: null
        };
        await setStorage({ timerState: pausedState });
      }

      const urlParams = new URLSearchParams(window.location.search);
      const originalUrl = urlParams.get('original');
      if (originalUrl) {
        window.location.href = originalUrl;
      } else {
        window.close();
      }
    });

    init().catch(err => console.error(i18n('error_init'), err));
  </script>
</body>
</html>
